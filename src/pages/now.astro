---
import PageLayout from "@/layouts/Base";
const meta = {
	title: "Now",
	description: "What I'm up to recently",
};
---
<PageLayout meta={meta}>
  <div class="space-y-6">
    <h1 class="title">Now</h1>
    <p>What I'm up to recently</p>
    <ul class="list-disc pl-4 space-y-4">
      <li>Working as Senior Solutions Engineer at Stablecore</li>
      <li>Focusing on building out my personal site</li>
      <li>Amateur astronomy when the sky is clear</li>
      <li>Collecting and listening to cassette tapes</li>
      <li>Testing out different fountain pen inks</li>
      <li>Reading The Dispossessed</li>
    </ul>
    <p class="text-gray-400">Last updated: January 3rd, 2026</p>
  <h2 class="text-xl font-semibold pt-12">Updates</h2>
  <div id="posts-container">
    <p>Loading...</p>
  </div>
  <script>
    const DID = 'did:plc:ia2zdnhjaokf5lazhxrmj6eu';
    const PDS_URL = 'https://polybius.social';

    // Fetch posts directly from your PDS using the repo.listRecords endpoint
    async function fetchPosts() {
      try {
        const response = await fetch(
          `${PDS_URL}/xrpc/com.atproto.repo.listRecords?` +
          new URLSearchParams({
            repo: DID,
            collection: 'app.bsky.feed.post',
            limit: '20',
            filter: 'posts_no_replies'
          })
        );

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (!data.records || data.records.length === 0) {
          document.getElementById('posts-container').innerHTML = '<p>No recent posts found.</p>';
          return;
        }

        // Filter out replies (posts that have a reply reference)
        const posts = data.records.filter(record => !record.value.reply);

        const postsHTML = posts.map(record => {
          const post = record.value;
          const createdAt = new Date(post.createdAt).toLocaleDateString();

          // Handle images
          let imagesHTML = '';
          if (post.embed && post.embed.$type === 'app.bsky.embed.images' && post.embed.images) {
            const imageElements = post.embed.images.map(image => {
              // Construct blob URL - images are stored as blobs on the PDS
              const blobUrl = `${PDS_URL}/xrpc/com.atproto.sync.getBlob?` +
                new URLSearchParams({
                  did: DID,
                  cid: image.image.ref.$link
                });

              return `
                <img
                  src="${blobUrl}"
                  alt="${image.alt || 'Image from post'}"
                  class="max-w-full h-auto"
                  loading="lazy"
                />
              `;
            }).join('');

            imagesHTML = `
              <div class="mt-3 grid gap-2 ${post.embed.images.length === 1 ? 'grid-cols-1' : 'grid-cols-2'}">
                ${imageElements}
              </div>
            `;
          }

          return `
            <article class="border-b pb-6 mb-6 last:border-b-0">
              <p class="mb-2">${post.text}</p>
              ${imagesHTML}
              <time class="text-sm text-gray-500 mt-2 block">${createdAt}</time>
            </article>
          `;
        }).join('');

        document.getElementById('posts-container').innerHTML = `
          <div class="space-y-4">
            <div>${postsHTML}</div>
          </div>
        `;
      } catch (err) {
        console.error('Error fetching posts:', err);
        document.getElementById('posts-container').innerHTML =
          '<p>Error loading recent posts. Make sure your PDS is accessible.</p>';
      }
    }

    fetchPosts();
  </script>
  </div>
</PageLayout>
