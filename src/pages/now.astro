---
import PageLayout from "@/layouts/Base";
const meta = {
	title: "Now",
	description: "What I'm up to recently",
};
---

<PageLayout meta={meta}>
  <div class="space-y-6">
    <h1 class="title">Now</h1>
    <p>What I'm up to recently</p>
    <ul class="list-disc pl-4 space-y-4">
      <li>Working as Senior Solutions Engineer at Stablecore</li>
      <li>Focusing on building out my personal site</li>
      <li>Amateur astronomy when the sky is clear</li>
      <li>Collecting and listening to cassette tapes</li>
      <li>Testing out different fountain pen inks</li>
      <li>Reading The Dispossessed</li>
    </ul>

  <h2 class="text-xl font-semibold pt-12">Updates</h2>
  <div id="posts-container">
    <p>Loading...</p>
  </div>

  <script>
    import { AtpAgent } from '@atproto/api';

    const urlParams = new URLSearchParams(window.location.search);
    const rkey = urlParams.get('rkey');
    const DID = 'did:plc:ia2zdnhjaokf5lazhxrmj6eu';
    const atUri = `at://${DID}/app.bsky.feed.post/${rkey}`;

    const agent = new AtpAgent({ service: 'https://public.api.bsky.app' });

    agent.app.bsky.feed.getAuthorFeed({
      actor: DID,
      limit: 20,
      filter: 'posts_no_replies'
    })
    .then(({ data }) => {
      const posts = data.feed;

      if (posts.length === 0) {
        document.getElementById('posts-container').innerHTML = '<p>No recent posts found.</p>';
        return;
      }

      const postsHTML = posts.map(feedItem => {
        const post = feedItem.post;
        const createdAt = new Date(post.record.createdAt).toLocaleDateString();

        // Handle images
        let imagesHTML = '';
        if (post.embed && post.embed.images) {
          const imageElements = post.embed.images.map(image => {
            return `
              <img
                src="${image.fullsize}"
                alt="${image.alt || 'Image from post'}"
                class="max-w-full h-auto"
                loading="lazy"
              />
            `;
          }).join('');

          imagesHTML = `
            <div class="mt-3 grid gap-2 ${post.embed.images.length === 1 ? 'grid-cols-1' : 'grid-cols-2'}">
              ${imageElements}
            </div>
          `;
        }

        return `
          <article class="border-b pb-4 mb-6 last:border-b-0">
            <p class="mb-2">${post.record.text}</p>
            ${imagesHTML}
            <time class="text-sm text-gray-500 mt-2 block">${createdAt}</time>
          </article>
        `;
      }).join('');

      document.getElementById('posts-container').innerHTML = `
        <div class="space-y-4">
          <div>${postsHTML}</div>
        </div>
      `;
    })
    .catch(err => {
      console.error('Error fetching posts:', err);
      document.getElementById('posts-container').innerHTML =
        '<p>Error loading recent posts.</p>';
    });
  </script>
  </div>

</PageLayout>
