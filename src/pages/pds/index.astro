---
import PageLayout from "@/layouts/Base";
const meta = {
	title: "PDS",
	description: "Posts",
};
---

<PageLayout meta={meta}>
  <div id="post-container">
    <p>Loading...</p>
  </div>

  <script>
    const DID = 'did:plc:ia2zdnhjaokf5lazhxrmj6eu';
    const PDS_URL = 'https://polybius.social';

    const urlParams = new URLSearchParams(window.location.search);
    const rkey = urlParams.get('rkey');

    async function fetchPost() {
      if (!rkey) {
        document.getElementById('post-container').innerHTML = '<p>No post specified.</p>';
        return;
      }

      try {
        const response = await fetch(
          `${PDS_URL}/xrpc/com.atproto.repo.getRecord?` +
          new URLSearchParams({
            repo: DID,
            collection: 'app.bsky.feed.post',
            rkey: rkey
          })
        );

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        const post = data.value;
        const createdAt = new Date(post.createdAt).toLocaleDateString();

        // Handle images
        let imagesHTML = '';
        if (post.embed && post.embed.$type === 'app.bsky.embed.images' && post.embed.images) {
          const imageElements = post.embed.images.map(image => {
            // Construct blob URL - images are stored as blobs on the PDS
            const blobUrl = `${PDS_URL}/xrpc/com.atproto.sync.getBlob?` +
              new URLSearchParams({
                did: DID,
                cid: image.image.ref.$link
              });

            return `
              <img
                src="${blobUrl}"
                alt="${image.alt || 'Image from post'}"
                class="max-w-full h-auto"
                loading="lazy"
              />
            `;
          }).join('');

          imagesHTML = `
            <div class="mt-3 grid gap-2 ${post.embed.images.length === 1 ? 'grid-cols-1' : 'grid-cols-2'}">
              ${imageElements}
            </div>
          `;
        }

        document.getElementById('post-container').innerHTML = `
          <article class="max-w-2xl mx-auto">
            <p class="mb-2">${post.text}</p>
            ${imagesHTML}
            <time class="text-sm text-gray-500 mt-2 block">${createdAt}</time>
          </article>
        `;

        document.title = post.text;
      } catch (err) {
        console.error('Error fetching post:', err);
        document.getElementById('post-container').innerHTML =
          '<p>Error loading post. Make sure your PDS is accessible.</p>';
      }
    }

    fetchPost();
  </script>

</PageLayout>
