---
import PageLayout from "@/layouts/Base";
import MarkdownIt from "markdown-it";
import { ReplyContainer } from "@/components/now/ReplyContainer";
import { OWNER_DID, PDS_URL } from "@/data/constants";

export const prerender = false;

const md = new MarkdownIt({
	html: false,
	linkify: true,
	typographer: true,
});

const { slug } = Astro.params;

if (!slug) {
	return Astro.redirect("/now");
}

let title = "Post";
let description = "A post from my PDS";
let contentHTML = "";
let publishedAt = "";
let atUri = "";
let errorMessage = "";
let isError = false;

try {
	let documentFound = false;

	// First, try to find a document with a matching custom path
	const listResponse = await fetch(
		`${PDS_URL}/xrpc/com.atproto.repo.listRecords?` +
			new URLSearchParams({
				repo: OWNER_DID,
				collection: "site.standard.document",
				limit: "100",
			}),
	);

	if (listResponse.ok) {
		const listData = await listResponse.json();
		const matchingDoc = listData.records.find((record: any) => {
			// Check if document has a custom path that matches
			const docPath = record.value.path;
			if (docPath) {
				// Remove leading slash for comparison
				const normalizedPath = docPath.startsWith("/")
					? docPath.slice(1)
					: docPath;
				// Match against the full path including /now/
				return normalizedPath === `now/${slug}`;
			}
			return false;
		});

		if (matchingDoc) {
			const doc = matchingDoc.value;
			title = doc.title || "Post";
			description = doc.content?.markdown?.slice(0, 160) || description;
			publishedAt = new Date(doc.publishedAt).toLocaleDateString();
			atUri = matchingDoc.uri;

			if (doc.content && doc.content.markdown) {
				contentHTML = md.render(doc.content.markdown);
			} else if (doc.textContent) {
				contentHTML = `<p>${doc.textContent}</p>`;
			}
			documentFound = true;
		}
	}

	// If no custom path match, try fetching by rkey
	if (!documentFound) {
		const documentResponse = await fetch(
			`${PDS_URL}/xrpc/com.atproto.repo.getRecord?` +
				new URLSearchParams({
					repo: OWNER_DID,
					collection: "site.standard.document",
					rkey: slug,
				}),
		);

		if (documentResponse.ok) {
			const data = await documentResponse.json();
			const doc = data.value;
			title = doc.title || "Post";
			description = doc.content?.markdown?.slice(0, 160) || description;
			publishedAt = new Date(doc.publishedAt).toLocaleDateString();
			atUri = `at://${OWNER_DID}/site.standard.document/${slug}`;

			if (doc.content && doc.content.markdown) {
				contentHTML = md.render(doc.content.markdown);
			} else if (doc.textContent) {
				contentHTML = `<p>${doc.textContent}</p>`;
			}
			documentFound = true;
		}
	}

	if (!documentFound) {
		Astro.response.status = 404;
		isError = true;
		title = "Not Found";
		errorMessage = "The post you're looking for doesn't exist.";
	}
} catch (err) {
	console.error("Error fetching post:", err);
	Astro.response.status = 500;
	isError = true;
	title = "Error";
	errorMessage = "Something went wrong while loading this post.";
}

const meta = {
	title,
	description,
	atUri,
};
---

<PageLayout meta={meta}>
	<article>
		{isError ? (
			<>
				<h1 class="text-2xl font-bold mb-4">{title}</h1>
				<p class="text-gray-400 mb-8">{errorMessage}</p>
				<a class="style-link" href="/now">&larr; Back to Now</a>
			</>
		) : (
			<>
				<h1 class="text-2xl font-bold mb-2">{title}</h1>
				<time class="text-sm text-gray-400">{publishedAt}</time>
				<div class="prose prose-invert max-w-none my-4">
					<Fragment set:html={contentHTML} />
				</div>
				<a href={`https://pdsls.dev/${atUri}`} target="_blank" rel="noreferrer" class="underline text-xs text-gray-400 mt-4 break-all">{atUri}</a>
				<div class="mt-12 flex items-center justify-between">
					<a class="style-link" href="/now">&larr; Now</a>
					<button
						id="share-btn"
						class="text-sm text-gray-500 hover:text-gray-700 transition-colors"
					>
						Share
					</button>
				</div>
				<ReplyContainer client:load atUri={atUri} postTitle={title} />
			</>
		)}
	</article>
</PageLayout>

<script>
	const btn = document.getElementById("share-btn");
	if (btn) {
		btn.addEventListener("click", () => {
			const url = window.location.href;
			navigator.clipboard
				.writeText(url)
				.then(() => {
					const originalText = btn.textContent;
					btn.textContent = "Copied!";
					setTimeout(() => {
						btn.textContent = originalText;
					}, 2000);
				})
				.catch((err) => {
					console.error("Failed to copy URL:", err);
					alert("Failed to copy URL");
				});
		});
	}
</script>
